[
  {
    "$kind": "defplan",
    "name": "demiurge/tool_plan@1",
    "input": "demiurge/ToolCallRequested@1",
    "steps": [
      {
        "id": "assign_tool_tag",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            { "ref": "@plan.input.params" },
            { "text": "$tag" }
          ]
        },
        "bind": { "as": "tool_tag" }
      },
      {
        "id": "emit_empty_root",
        "op": "emit_effect",
        "kind": "workspace.empty_root",
        "params": {
          "record": {
            "workspace": { "text": "demiurge" }
          }
        },
        "cap": "cap_workspace",
        "bind": { "effect_id_as": "empty_root" }
      },
      {
        "id": "await_empty_root",
        "op": "await_receipt",
        "for": { "ref": "@var:empty_root" },
        "bind": { "as": "empty_root_receipt" }
      },
      {
        "id": "assign_empty_root_hash",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            { "ref": "@var:empty_root_receipt" },
            { "text": "root_hash" }
          ]
        },
        "bind": { "as": "empty_root_hash" }
      },
      {
        "id": "emit_introspect_manifest",
        "op": "emit_effect",
        "kind": "introspect.manifest",
        "params": {
          "record": {
            "consistency": {
              "op": "get",
              "args": [
                {
                  "op": "get",
                  "args": [
                    { "ref": "@plan.input.params" },
                    { "text": "$value" }
                  ]
                },
                { "text": "consistency" }
              ]
            }
          }
        },
        "cap": "cap_query",
        "bind": { "effect_id_as": "introspect_manifest" }
      },
      {
        "id": "await_introspect_manifest",
        "op": "await_receipt",
        "for": { "ref": "@var:introspect_manifest" },
        "bind": { "as": "introspect_manifest_receipt" }
      },
      {
        "id": "assign_manifest_bytes",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            { "ref": "@var:introspect_manifest_receipt" },
            { "text": "manifest" }
          ]
        },
        "bind": { "as": "tool_bytes" }
      },
      {
        "id": "emit_store_manifest",
        "op": "emit_effect",
        "kind": "workspace.write_bytes",
        "params": {
          "record": {
            "root_hash": { "ref": "@var:empty_root_hash" },
            "path": {
              "op": "concat",
              "args": [
                { "text": "tool-output-" },
                { "ref": "@plan.input.tool_call_id" }
              ]
            },
            "bytes": { "ref": "@var:tool_bytes" },
            "mode": { "null": {} }
          }
        },
        "cap": "cap_workspace",
        "bind": { "effect_id_as": "store_manifest" }
      },
      {
        "id": "await_store_manifest",
        "op": "await_receipt",
        "for": { "ref": "@var:store_manifest" },
        "bind": { "as": "store_manifest_receipt" }
      },
      {
        "id": "assign_manifest_ref",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            { "ref": "@var:store_manifest_receipt" },
            { "text": "blob_hash" }
          ]
        },
        "bind": { "as": "result_ref" }
      },
      {
        "id": "emit_workspace_resolve",
        "op": "emit_effect",
        "kind": "workspace.resolve",
        "params": {
          "record": {
            "workspace": {
              "op": "get",
              "args": [
                {
                  "op": "get",
                  "args": [
                    { "ref": "@plan.input.params" },
                    { "text": "$value" }
                  ]
                },
                { "text": "workspace" }
              ]
            },
            "version": {
              "op": "get",
              "args": [
                {
                  "op": "get",
                  "args": [
                    { "ref": "@plan.input.params" },
                    { "text": "$value" }
                  ]
                },
                { "text": "version" }
              ]
            }
          }
        },
        "cap": "cap_workspace",
        "bind": { "effect_id_as": "workspace_resolve" }
      },
      {
        "id": "await_workspace_resolve",
        "op": "await_receipt",
        "for": { "ref": "@var:workspace_resolve" },
        "bind": { "as": "workspace_resolve_receipt" }
      },
      {
        "id": "assign_workspace_root",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            { "ref": "@var:workspace_resolve_receipt" },
            { "text": "root_hash" }
          ]
        },
        "bind": { "as": "workspace_root" }
      },
      {
        "id": "emit_workspace_read_bytes",
        "op": "emit_effect",
        "kind": "workspace.read_bytes",
        "params": {
          "record": {
            "root_hash": { "ref": "@var:workspace_root" },
            "path": {
              "op": "get",
              "args": [
                {
                  "op": "get",
                  "args": [
                    { "ref": "@plan.input.params" },
                    { "text": "$value" }
                  ]
                },
                { "text": "path" }
              ]
            },
            "range": { "null": {} }
          }
        },
        "cap": "cap_workspace",
        "bind": { "effect_id_as": "workspace_read_bytes" }
      },
      {
        "id": "await_workspace_read_bytes",
        "op": "await_receipt",
        "for": { "ref": "@var:workspace_read_bytes" },
        "bind": { "as": "workspace_read_bytes_receipt" }
      },
      {
        "id": "assign_workspace_bytes",
        "op": "assign",
        "expr": { "ref": "@var:workspace_read_bytes_receipt" },
        "bind": { "as": "tool_bytes" }
      },
      {
        "id": "emit_store_workspace_bytes",
        "op": "emit_effect",
        "kind": "workspace.write_bytes",
        "params": {
          "record": {
            "root_hash": { "ref": "@var:empty_root_hash" },
            "path": {
              "op": "concat",
              "args": [
                { "text": "tool-output-" },
                { "ref": "@plan.input.tool_call_id" }
              ]
            },
            "bytes": { "ref": "@var:tool_bytes" },
            "mode": { "null": {} }
          }
        },
        "cap": "cap_workspace",
        "bind": { "effect_id_as": "store_workspace_bytes" }
      },
      {
        "id": "await_store_workspace_bytes",
        "op": "await_receipt",
        "for": { "ref": "@var:store_workspace_bytes" },
        "bind": { "as": "store_workspace_bytes_receipt" }
      },
      {
        "id": "assign_workspace_ref",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            { "ref": "@var:store_workspace_bytes_receipt" },
            { "text": "blob_hash" }
          ]
        },
        "bind": { "as": "result_ref" }
      },
      {
        "id": "raise_tool_result",
        "op": "raise_event",
        "event": "demiurge/ChatEvent@1",
        "value": {
          "variant": {
            "tag": "ToolResult",
            "value": {
              "record": {
                "request_id": { "ref": "@plan.input.request_id" },
                "chat_id": { "ref": "@plan.input.chat_id" },
                "tool_call_id": { "ref": "@plan.input.tool_call_id" },
                "result_ref": { "ref": "@var:result_ref" }
              }
            }
          }
        }
      },
      { "id": "finish", "op": "end" }
    ],
    "edges": [
      { "from": "assign_tool_tag", "to": "emit_empty_root" },
      { "from": "emit_empty_root", "to": "await_empty_root" },
      { "from": "await_empty_root", "to": "assign_empty_root_hash" },

      {
        "from": "assign_empty_root_hash",
        "to": "emit_introspect_manifest",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "IntrospectManifest" }
          ]
        }
      },
      {
        "from": "emit_introspect_manifest",
        "to": "await_introspect_manifest",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "IntrospectManifest" }
          ]
        }
      },
      {
        "from": "await_introspect_manifest",
        "to": "assign_manifest_bytes",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "IntrospectManifest" }
          ]
        }
      },
      {
        "from": "assign_manifest_bytes",
        "to": "emit_store_manifest",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "IntrospectManifest" }
          ]
        }
      },
      {
        "from": "emit_store_manifest",
        "to": "await_store_manifest",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "IntrospectManifest" }
          ]
        }
      },
      {
        "from": "await_store_manifest",
        "to": "assign_manifest_ref",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "IntrospectManifest" }
          ]
        }
      },
      {
        "from": "assign_manifest_ref",
        "to": "raise_tool_result",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "IntrospectManifest" }
          ]
        }
      },

      {
        "from": "assign_empty_root_hash",
        "to": "emit_workspace_resolve",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "WorkspaceReadBytes" }
          ]
        }
      },
      {
        "from": "emit_workspace_resolve",
        "to": "await_workspace_resolve",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "WorkspaceReadBytes" }
          ]
        }
      },
      {
        "from": "await_workspace_resolve",
        "to": "assign_workspace_root",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "WorkspaceReadBytes" }
          ]
        }
      },
      {
        "from": "assign_workspace_root",
        "to": "emit_workspace_read_bytes",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "WorkspaceReadBytes" }
          ]
        }
      },
      {
        "from": "emit_workspace_read_bytes",
        "to": "await_workspace_read_bytes",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "WorkspaceReadBytes" }
          ]
        }
      },
      {
        "from": "await_workspace_read_bytes",
        "to": "assign_workspace_bytes",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "WorkspaceReadBytes" }
          ]
        }
      },
      {
        "from": "assign_workspace_bytes",
        "to": "emit_store_workspace_bytes",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "WorkspaceReadBytes" }
          ]
        }
      },
      {
        "from": "emit_store_workspace_bytes",
        "to": "await_store_workspace_bytes",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "WorkspaceReadBytes" }
          ]
        }
      },
      {
        "from": "await_store_workspace_bytes",
        "to": "assign_workspace_ref",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "WorkspaceReadBytes" }
          ]
        }
      },
      {
        "from": "assign_workspace_ref",
        "to": "raise_tool_result",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@var:tool_tag" },
            { "text": "WorkspaceReadBytes" }
          ]
        }
      },

      { "from": "raise_tool_result", "to": "finish" }
    ],
    "required_caps": ["cap_query", "cap_workspace"],
    "allowed_effects": [
      "introspect.manifest",
      "workspace.empty_root",
      "workspace.resolve",
      "workspace.read_bytes",
      "workspace.write_bytes"
    ]
  }
]
