[
  {
    "$kind": "defplan",
    "name": "demiurge/session_workspace_sync_wrapper@1",
    "input": "aos.agent/SessionEvent@1",
    "steps": [
      {
        "id": "assign_event_tag",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            {
              "op": "get",
              "args": [{ "ref": "@plan.input" }, { "text": "event" }]
            },
            { "text": "$tag" }
          ]
        },
        "bind": { "as": "event_tag" }
      },
      {
        "id": "assign_event_value",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            {
              "op": "get",
              "args": [{ "ref": "@plan.input" }, { "text": "event" }]
            },
            { "text": "$value" }
          ]
        },
        "bind": { "as": "event_value" }
      },
      {
        "id": "spawn_core_workspace_sync",
        "op": "spawn_plan",
        "plan": "aos.agent/core_workspace_sync@1",
        "input": { "ref": "@var:event_value" },
        "bind": { "handle_as": "core_handle" }
      },
      {
        "id": "await_core_workspace_sync",
        "op": "await_plan",
        "for": { "ref": "@var:core_handle" },
        "bind": { "as": "core_result" }
      },
      {
        "id": "assign_core_result_tag",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [{ "ref": "@var:core_result" }, { "text": "$tag" }]
        },
        "bind": { "as": "core_result_tag" }
      },
      {
        "id": "assign_core_event_kind",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [{ "ref": "@var:core_result" }, { "text": "$value" }]
        },
        "bind": { "as": "core_event_kind" }
      },
      {
        "id": "raise_session_event_from_core",
        "op": "raise_event",
        "event": "aos.agent/SessionEvent@1",
        "value": {
          "record": {
            "session_id": { "ref": "@plan.input.session_id" },
            "run_id": { "null": {} },
            "turn_id": { "null": {} },
            "step_id": { "null": {} },
            "session_epoch": { "ref": "@plan.input.session_epoch" },
            "step_epoch": { "ref": "@plan.input.step_epoch" },
            "event": { "ref": "@var:core_event_kind" }
          }
        }
      },
      {
        "id": "raise_workspace_sync_failed",
        "op": "raise_event",
        "event": "aos.agent/SessionEvent@1",
        "value": {
          "record": {
            "session_id": { "ref": "@plan.input.session_id" },
            "run_id": { "null": {} },
            "turn_id": { "null": {} },
            "step_id": { "null": {} },
            "session_epoch": { "ref": "@plan.input.session_epoch" },
            "step_epoch": { "ref": "@plan.input.step_epoch" },
            "event": {
              "variant": {
                "tag": "WorkspaceSyncFailed",
                "value": {
                  "record": {
                    "workspace": {
                      "op": "get",
                      "args": [
                        {
                          "op": "get",
                          "args": [
                            { "ref": "@var:event_value" },
                            { "text": "workspace_binding" }
                          ]
                        },
                        { "text": "workspace" }
                      ]
                    },
                    "stage": { "text": "workspace_sync_core" },
                    "detail": {
                      "op": "get",
                      "args": [
                        {
                          "op": "get",
                          "args": [{ "ref": "@var:core_result" }, { "text": "$value" }]
                        },
                        { "text": "message" }
                      ]
                    }
                  }
                }
              }
            }
          }
        }
      },
      { "id": "finish", "op": "end" }
    ],
    "edges": [
      {
        "from": "assign_event_tag",
        "to": "assign_event_value",
        "when": {
          "op": "eq",
          "args": [{ "ref": "@var:event_tag" }, { "text": "WorkspaceSyncRequested" }]
        }
      },
      {
        "from": "assign_event_tag",
        "to": "finish",
        "when": {
          "op": "ne",
          "args": [{ "ref": "@var:event_tag" }, { "text": "WorkspaceSyncRequested" }]
        }
      },
      { "from": "assign_event_value", "to": "spawn_core_workspace_sync" },
      { "from": "spawn_core_workspace_sync", "to": "await_core_workspace_sync" },
      { "from": "await_core_workspace_sync", "to": "assign_core_result_tag" },
      {
        "from": "assign_core_result_tag",
        "to": "assign_core_event_kind",
        "when": {
          "op": "eq",
          "args": [{ "ref": "@var:core_result_tag" }, { "text": "Ok" }]
        }
      },
      {
        "from": "assign_core_result_tag",
        "to": "raise_workspace_sync_failed",
        "when": {
          "op": "ne",
          "args": [{ "ref": "@var:core_result_tag" }, { "text": "Ok" }]
        }
      },
      { "from": "assign_core_event_kind", "to": "raise_session_event_from_core" },
      { "from": "raise_session_event_from_core", "to": "finish" },
      { "from": "raise_workspace_sync_failed", "to": "finish" }
    ],
    "required_caps": [],
    "allowed_effects": []
  }
]
