# P3.2: Agent Prompt Sources Contract (Workspace + Direct Config)

**Priority**: P3  
**Effort**: Medium  
**Risk if deferred**: High (prompt composition remains app-specific and workspace-only)  
**Status**: Proposed (refined scope on 2026-02-22)

## Goal

Define a reusable SDK prompt contract that supports two first-class paths:

1. prompt content in a dedicated workspace (versioned, sync/apply),
2. prompt content passed directly in session/run config without workspace.

This document is now prompt-only. Tool concerns move to `p3.3-agent-tools.md`.

## Why Split

Prompts and tools have different ownership and risk profiles:

1. Prompts are content selection/materialization concerns.
2. Tools are authority/binding concerns and need stricter control-plane rules.

Keeping them in one contract made design choices harder to reason about.

## Current Baseline (Implemented)

1. Workspace snapshot contracts exist:
   - `WorkspaceBinding`, `WorkspaceSnapshot`, `WorkspaceSyncRequested`, `WorkspaceApplyRequested`.
2. Workspace sync/apply flow exists via `aos.agent/core_workspace_sync@1`.
3. Prompt pack ref is prepended to step `message_refs` during materialization.
4. Workspace prompt JSON is validated before snapshot stage/apply.

Current implementation note:

1. `aos.agent/core_workspace_sync@1` currently resolves both prompt and tool workspace assets in one plan.

## Problem

Today prompt loading is effectively workspace-centric. That is good for shared app content, but too heavy for:

1. simple agents,
2. tests and fixtures,
3. clients that already store prompt blobs in CAS and just want to run.

We need a no-workspace prompt path that still stays deterministic and typed.

## Decision Summary

1. Prompt source is a per-run decision with two modes:
   - `WorkspacePromptPack`
   - `DirectPromptRefs`
2. Workspace support remains optional in SDK usage.
3. Prompt materialization always outputs `message_refs` for `sys/llm.generate`.
4. Run immutability still applies: chosen prompt source is frozen per run.
5. SDK should export prompt sync as a standalone composable-core plan.
6. Direct prompt refs path should not require any sync plan.

## SDK Plan Exports (Prompts)

Target reusable plans in `crates/aos-agent-sdk/air/plans/`:

1. `aos.agent/core_prompt_sync_from_workspace@1`
   - input: prompt-specific workspace sync request contract,
   - output: prompt snapshot-ready or unchanged result contract.
2. optional `aos.agent/core_workspace_sync@2`
   - orchestration-only plan that composes prompt/tool sync subplans via `spawn_plan` + `await_plans_all`.

Refactor direction:

1. split current `core_workspace_sync@1` into prompt and tool subplans,
2. keep composition explicit and typed,
3. avoid app-local duplication of prompt sync logic.

## Prompt Source Model

### A) Workspace Prompt Pack

Current model stays:

1. `workspace_binding` + `prompt_pack` identify content.
2. Explicit sync/apply controls adoption timing.
3. Active snapshot contributes `prompt_pack_ref`.

### B) Direct Prompt Refs (No Workspace)

Add direct prompt refs to config (next contract rev):

1. Session defaults:
   - `default_prompt_refs: option<list<hash>>`
2. Run overrides:
   - `prompt_refs: option<list<hash>>`

These refs point to provider-agnostic message JSON blobs already stored in CAS.
No workspace sync/apply plan is needed for this path.

## Resolution and Precedence

For each step, resolve base prompt refs in this order:

1. `run_config.prompt_refs` (if set)
2. active workspace snapshot `prompt_pack_ref` (if set)
3. none

Then append step history refs (oldest -> newest).

Notes:

1. If both direct refs and workspace snapshot exist, direct refs win for that run.
2. Empty final `message_refs` is still invalid.

## Proposed Config Additions (Prompt-Only)

`aos.agent/SessionConfig@next`:

1. keep existing provider/model fields,
2. keep `workspace_binding` and `default_prompt_pack`,
3. add `default_prompt_refs: option<list<hash>>`.

`aos.agent/RunConfig@next`:

1. keep existing provider/model fields,
2. keep `workspace_binding` and `prompt_pack`,
3. add `prompt_refs: option<list<hash>>`.

Tool fields are specified in `p3.3-agent-tools.md`.

## Workspace Index Role (Prompt Scope)

`agent.workspace.json` remains optional metadata for workspace-based agents:

1. prompt pack name -> file path mapping,
2. defaults.

Convention-first path is primary:

1. `prompts/packs/<pack>.json`

No extra prompt metadata layer is required to run.

## Determinism and Governance

1. Both prompt modes resolve to immutable hash refs in run config/state.
2. Workspace updates affect runtime only after explicit sync/apply.
3. Direct prompt refs affect runtime only when selected by a new run request.
4. Reducers still do not execute external effects for prompt resolution.

## Runtime Path by Source

### Workspace source

1. reducer emits/handles workspace prompt sync request,
2. imported SDK prompt sync plan resolves pack ref/bytes deterministically,
3. reducer validates and stages/applies active prompt snapshot.

### Direct refs source

1. reducer materializes run config with direct prompt refs,
2. step materialization uses those refs directly,
3. no workspace effect orchestration is involved.

## Implementation Focus

1. Add direct prompt ref fields to SDK contracts/schemas.
2. Export prompt-only sync core plan in SDK AIR.
3. Refactor current monolithic workspace sync plan into composable subplans.
4. Update prompt materialization helper:
   - prefer direct prompt refs over workspace prompt pack ref.
5. Add tests for:
   - workspace mode,
   - direct mode,
   - precedence when both are present.

## Testing

Deterministic coverage:

1. Direct prompt refs run without any workspace config/events.
2. Workspace prompt pack sync/apply remains replay-identical.
3. When both sources are present, precedence is deterministic.
4. Mid-run workspace apply does not mutate current run config.

## Definition of Done

1. Prompt contract is documented as prompt-only, separate from tools.
2. SDK exports a prompt-specific reusable sync plan.
3. SDK supports prompt inputs via workspace and direct config refs.
4. At least one smoke scenario runs with direct prompt refs and no workspace binding.
5. Existing workspace smoke flow continues to pass replay parity.

## Open Questions

1. Should direct prompt refs be constrained to one blob or allow multiple refs?
2. Should we also support an inline-text convenience path, or keep refs-only for v0.10?
3. Should workspace prompt defaults be auto-resolved from `agent.workspace.json`, or stay explicit in session/run config?
