# P2.1: Session Contracts and Core `aos.agent/*` Schemas

**Stage**: P2.1  
**Status**: Proposed  
**Depends on**: P1 complete

## Purpose

Establish the base session lifecycle and host-control contract so every agent app shares the same run semantics.

This stage resolves the primary gap from concern #1 (host-control underspecified) and lays schema foundations used by all later stages.

## Scope

1. Define core SDK schemas under `aos.agent/*`:
   - `aos.agent/SessionId@1`
   - `aos.agent/RunId@1`
   - `aos.agent/TurnId@1`
   - `aos.agent/StepId@1`
   - `aos.agent/SessionLifecycle@1`
   - `aos.agent/HostCommand@1`
   - `aos.agent/SessionState@1`
   - `aos.agent/SessionEvent@1`
2. Define lifecycle states and transitions:
   - `Idle`, `Running`, `WaitingInput`, `Paused`, `Cancelling`, `Completed`, `Failed`, `Cancelled`
3. Define control observation semantics:
   - `steer`, `follow_up`, `reconfigure`, `pause`, `resume`, `cancel`
4. Define epoch fences to ignore stale completions:
   - `session_epoch`
   - `step_epoch`
5. Add crate scaffolding:
   - `crates/aos-agent-sdk` with shared types and reducer helper traits.

## Non-Goals

- Provider-specific profile logic.
- Tool bounding/truncation.
- Streaming/event transport details.

## Deliverables

1. New AIR schema files for session lifecycle/control contracts.
2. `aos-agent-sdk` crate with:
   - core IDs and state/event types,
   - lifecycle transition helpers,
   - command-queue semantics (`steer`, `follow_up`).
3. Template keyed reducer and routing conventions:
   - key by `session_id`,
   - route `SessionEvent` to `SessionReducer`.

## Specs Alignment

- `spec/03-air.md`: event-triggered plans and strict schema validation.
- `spec/04-reducers.md`: reducer owns state transitions and business logic.
- `spec/02-architecture.md`: journal-backed determinism and receipts.

## Exit Criteria

1. Deterministic no-tool run works end-to-end with lifecycle transitions.
2. `steer` is observed at step boundary before next LLM step.
3. `follow_up` is queued and consumed only after current run reaches `Idle`/`WaitingInput`.
4. `cancel` transitions to `Cancelling` and ultimately `Cancelled`; stale late results are ignored by epoch fence.
5. Replay test proves byte-identical final state for equivalent journal.

