# P2.5: Failure Taxonomy, Retry Ownership, and Cancellation

**Stage**: P2.5  
**Status**: Proposed  
**Depends on**: P2.1, P2.2, P2.3, P2.4

## Purpose

Define shared failure semantics so identical failures produce identical behavior across apps.

This stage resolves concern #6 and finalizes cancellation semantics from concern #4.

## Scope

1. Canonical failure taxonomy:
   - policy denial,
   - capability denial,
   - validation error,
   - adapter timeout/error,
   - provider retryable/terminal error,
   - tool not found/invalid args,
   - invariant violation.
2. Retry ownership boundaries:
   - adapter retries,
   - plan retries,
   - reducer decision retries.
3. Canonical terminal states and transition rules:
   - `Completed`, `Failed`, `Cancelled`.
4. Cancellation ordering contract:
   - accepted cancel command,
   - `Cancelling`,
   - late-result ignore,
   - `Cancelled`.
5. In-flight parallel effect handling:
   - partial completion classification,
   - deterministic settle on cancel.

## Non-Goals

- Cross-world cancellation protocols (universe work).
- Budget/economics policy (future stage).

## Deliverables

1. Error envelope schema with structured cause + correlation.
2. Retry policy guidance and helper interfaces in `aos-agent-sdk`.
3. Cancellation sequence rules and epoch-fence enforcement helpers.
4. Integration tests for deny/error/timeout/cancel behavior.
5. Integration tests for partial parallel completion and cancel during fan-out.

## Implementation Notes

- Keep all retry/cancel effects deterministic at reducer decision level.
- Avoid hidden retry loops inside app-specific code paths.
- Adapter retries are transport-level only and must not duplicate a committed tool call id.
- Plan retries own effect re-dispatch policy; reducer retries own state-transition policy.
- At most one layer may retry a given failure class in a given path (single owner rule).

### Cancellation sequence (normative)

1. Host command accepted and journaled with `command_id`.
2. Reducer transitions to `Cancelling` and bumps epoch fence.
3. No new effect intents are emitted after transition to `Cancelling`.
4. In-flight receipts are ingested:
   - matching epoch/run: mark call terminal (`Succeeded` or `Failed`),
   - stale epoch/run: mark `IgnoredStale`.
5. Run transitions to `Cancelled` when all call ids in active batch are terminal or ignored stale.
6. Terminal event includes typed cancellation cause and correlation ids.

## Exit Criteria

1. Each failure class maps to deterministic terminal or recoverable behavior.
2. Retry ownership is tested and unambiguous (no duplicate retry loops across layers).
3. Cancel during in-flight operations reaches `Cancelled` deterministically and ignores stale late completions.
4. Policy/cap deny paths are distinguishable by typed error code and correlation IDs.
5. Partial-success/partial-failure fan-out during cancellation produces deterministic final classification.
6. Replay parity holds for failed and cancelled runs.
