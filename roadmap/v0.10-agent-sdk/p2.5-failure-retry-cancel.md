# P2.5: Failure Taxonomy, Retry Ownership, and Cancellation (MVP Slice)

**Stage**: P2.5  
**Status**: Complete (MVP slice verified on 2026-02-14)  
**Depends on**: P2.1, P2.2, P2.3, P2.4

## Purpose

Define only the minimum shared failure contract needed so equivalent failures produce equivalent behavior across apps today.

P2.1 remains the source of truth for lifecycle/cancel fences. This stage adds a small, explicit failure-code and retry-ownership contract on top of existing behavior.

## Implementation Progress (2026-02-14)

Completed:

1. Added canonical failure-code contract to SDK:
   - `FailureCode` vocabulary with stable string mapping/parsing.
2. Added retry ownership helper contract to SDK:
   - deterministic single-owner mapping (`Adapter` vs `Plan` vs `Reducer`).
3. Added SDK helper constructors for canonicalized failure payloads:
   - `RunFailed` event helper,
   - tool-call failed status helper.
4. Added SDK unit coverage for:
   - code round-trip/parsing,
   - single-owner retry mapping,
   - canonical payload construction.
5. Hardened CLI trace diagnosis classification:
   - explicit `invariant_violation`,
   - fallback `unknown_failure` for generic plan errors.
6. Added CLI unit coverage for deny/cap/timeout/error/invariant classification mappings.
7. Confirmed existing deterministic cancellation/fan-out/replay coverage remains active via:
   - `10-agent-session` smoke fixture (cancel + stale + fan-in),
   - host replay classification test.

## Already In Place

1. Deterministic cancellation fence behavior:
   - `Cancelling` transition,
   - `session_epoch` + `step_epoch` bump,
   - stale late results marked `IgnoredStale`,
   - deterministic finalize to `Cancelled`.
2. Terminal lifecycle states and base events:
   - `Completed`, `Failed`, `Cancelled`,
   - `RunFailed { code, detail }`,
   - `RunCancelled { reason }`.
3. Host adapter failure normalization:
   - transport-level failures surfaced as receipt `Error`/`Timeout`.
4. Trace-level classification substrate:
   - deny/error/timeout/plan-error signals already queryable.

## Scope (Land Now)

1. Canonical failure code vocabulary (string codes):
   - `policy_denied`,
   - `capability_denied`,
   - `validation_error`,
   - `adapter_timeout`,
   - `adapter_error`,
   - `provider_retryable`,
   - `provider_terminal`,
   - `tool_not_found`,
   - `tool_invalid_args`,
   - `invariant_violation`,
   - `unknown_failure`.
2. Retry ownership contract (single-owner rule):
   - adapter owns transport retries only,
   - plan owns orchestration/effect re-dispatch retries,
   - reducer owns state-machine retry decisions,
   - one failure class in one path has exactly one retry owner.
3. Minimal SDK helper surface:
   - helper mapping from observed signals (receipt/deny/plan error) to canonical failure codes,
   - helper constructors for deterministic `RunFailed`/tool-failed statuses using canonical codes.
4. Conformance tests:
   - deny/error/timeout class mapping tests,
   - cancel during in-flight fan-out with partial completion,
   - replay parity for failed/cancelled paths and classifications.

## Deferred (Post-MVP)

1. New error envelope schema family.
2. Automatic retry orchestration framework (backoff strategies, retry budget engine).
3. Cross-world cancellation protocol.
4. Budget/economics policy integration.
5. Full provider-specific failure taxonomy expansion beyond MVP codes.

## Non-Goals

- New kernel primitives for failure handling.
- Moving app-specific retry loops into kernel/runtime internals.
- Replacing existing journal/trace truth with a new failure stream.

## Deliverables

1. Documented canonical failure code list and mapping guidance.
2. Documented retry ownership matrix (adapter vs plan vs reducer).
3. Small `aos-agent-sdk` helper functions for deterministic code mapping/construction.
4. Integration tests covering:
   - policy/cap deny distinction,
   - adapter timeout/error distinction,
   - cancel + stale late result behavior during fan-out,
   - replay-stable failed/cancelled interpretation.

## Implementation Notes

- Keep failure handling deterministic at reducer-decision level.
- Avoid hidden retries in multiple layers for the same failure class.
- Preserve P2.1 cancellation ordering and fence behavior exactly.
- Use existing journal/trace surfaces for validation and diagnostics rather than introducing a new authoritative channel.

## Exit Criteria

1. Canonical failure codes are documented and used consistently in SDK-facing failure paths.
2. Retry ownership is explicit and tested (no duplicate retry loops across layers for the same failure class/path).
3. Cancel during in-flight operations deterministically reaches `Cancelled` with stale late completions ignored.
4. Policy/cap deny and adapter timeout/error paths are distinguishable by canonical code.
5. Replay parity holds for failed and cancelled runs, including classification interpretation.
6. No kernel/AIR primitive additions are required for this MVP slice.
