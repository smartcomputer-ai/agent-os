# P2.5: Failure Taxonomy, Retry Ownership, and Cancellation

**Stage**: P2.5  
**Status**: Proposed  
**Depends on**: P2.1, P2.2, P2.3, P2.4

## Purpose

Define shared failure semantics so identical failures produce identical behavior across apps.

This stage resolves concern #6 and finalizes cancellation semantics from concern #4.

## Scope

1. Canonical failure taxonomy:
   - policy denial,
   - capability denial,
   - validation error,
   - adapter timeout/error,
   - provider retryable/terminal error,
   - tool not found/invalid args,
   - invariant violation.
2. Retry ownership boundaries:
   - adapter retries,
   - plan retries,
   - reducer decision retries.
3. Canonical terminal states and transition rules:
   - `Completed`, `Failed`, `Cancelled`.
4. Cancellation ordering contract:
   - accepted cancel command,
   - `Cancelling`,
   - late-result ignore,
   - `Cancelled`.

## Non-Goals

- Cross-world cancellation protocols (universe work).
- Budget/economics policy (future stage).

## Deliverables

1. Error envelope schema with structured cause + correlation.
2. Retry policy guidance and helper interfaces in `aos-agent-sdk`.
3. Cancellation sequence rules and epoch-fence enforcement helpers.
4. Integration tests for deny/error/timeout/cancel behavior.

## Implementation Notes

- Keep all retry/cancel effects deterministic at reducer decision level.
- Avoid hidden retry loops inside app-specific code paths.

## Exit Criteria

1. Each failure class maps to deterministic terminal or recoverable behavior.
2. Retry ownership is tested and unambiguous (no duplicate retry loops across layers).
3. Cancel during in-flight operations reaches `Cancelled` deterministically and ignores stale late completions.
4. Policy/cap deny paths are distinguishable by typed error code and correlation IDs.
5. Replay parity holds for failed and cancelled runs.

