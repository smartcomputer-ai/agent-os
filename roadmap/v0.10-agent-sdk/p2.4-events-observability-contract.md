# P2.4: Event and Observability Contract

**Stage**: P2.4  
**Status**: Proposed  
**Depends on**: P2.1, P2.2, P2.3

## Purpose

Make agent events a stable API for UIs and headless automation, not ad hoc debug output.

This stage resolves concern #5.

## Scope

1. Define canonical SDK event schema:
   - `aos.agent/AgentEvent@1`
2. Required event fields:
   - `session_id`, `run_id`, `turn_id`, `step_id`,
   - `event_seq`,
   - `correlation_id`,
   - `causation` (event hash or intent hash).
3. Canonical event families:
   - lifecycle,
   - llm step,
   - tool call,
   - host control,
   - diagnostics.
4. Ordering/correlation guarantees:
   - durable order = journal order,
   - telemetry order = best effort with cursor metadata.
5. Payload channel policy:
   - bounded model channel,
   - full-fidelity operator channel.
6. Internal/external event mapping contract:
   - `SessionEvent@1` as reducer input/internal lifecycle event,
   - `AgentEvent@1` as external API/stream surface.

## Non-Goals

- New kernel primitives for streaming.
- Product-level UI decisions.

## Deliverables

1. `AgentEvent` schema family and versioning policy.
2. Event emission helpers in `aos-agent-sdk`.
3. Contract notes for HTTP/SSE surfaces (cursor, resume, duplicate handling).
4. Trace/correlation rules aligned with existing `trace-get` workflow.
5. Deterministic mapping spec from `SessionEvent@1` and journal entries to `AgentEvent@1`.

## Implementation Notes

- Align with `roadmap/v0.10-agent-sdk/p9-stream.md` but keep deterministic boundaries explicit: journal-derived events are authoritative.
- Ensure every externally visible transition maps to a canonical event kind.
- `AgentEvent@1.event_seq` must be monotonic within `(session_id, run_id)` by journal order.
- `AgentEvent@1.correlation_id` should equal run-scoped correlation id for all events in one run unless explicitly forked by tool call id.

## Exit Criteria

1. A headless consumer can reconstruct run progression from the event stream plus journal cursor.
2. No required correlation field is missing in integration tests.
3. Resume-from-cursor works without duplication of durable events.
4. Event schema evolution policy documented (additive changes, version bump rules).
5. `SessionEvent@1 -> AgentEvent@1` mapping is complete for every externally visible transition.
6. Event contract validated in at least one UI integration path and one headless harness.
