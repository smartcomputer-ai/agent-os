# P2.4: Event and Observability Contract (Boundary-Safe Slice)

**Stage**: P2.4  
**Status**: Complete (boundary-safe slice verified on 2026-02-14)  
**Depends on**: P2.1, P2.2, P2.3

## Purpose

Make agent observability stable for UI/headless consumers while preserving AOS boundaries:

- **Authoritative truth remains** journal + reducer state + receipts.
- **No new app-level kernel primitive** is introduced.
- Any convenience view is an **edge projection** (host/CLI/UI), never kernel truth.

This stage resolves concern #5 without moving application concerns into the kernel.

## Implementation Progress (2026-02-14)

Completed:

1. Re-scoped P2.4 to a boundary-safe contract slice:
   - no kernel/AIR app-level event primitive added,
   - journal/state/receipts remain authoritative.
2. Documented explicit cursor contract for journal-based consumers:
   - `from` as cursor sequence,
   - resume using last processed `seq`,
   - ascending durable order and bootstrap note.
3. Aligned surface docs/help text with cursor semantics:
   - HTTP journal query docs (`/api/journal`),
   - CLI `journal tail --from` help text.
4. Added integration coverage for cursor resume and duplicate handling:
   - control-path pagination reconstruction with no durable duplicates,
   - HTTP-path cursor forwarding and no-dup pagination behavior.
5. Added integration coverage for agent lineage/correlation fields:
   - session-style lineage fields validated through `trace-get` correlation mode (`session_id`, `run_id`, `turn_id`, `step_id`).
6. Confirmed replay-stable terminal interpretation remains covered by existing host replay test (`trace terminal classification matches after replay`).

## Boundary Rules (Normative)

1. Kernel and journal stay generic and authoritative.
2. `aos.agent/SessionEvent@1` remains the internal session lifecycle contract.
3. Any "agent timeline" representation is derived from journal/state at read time.
4. Edge projections must carry source pointers (`journal_seq`, `event_hash`/`intent_hash`) back to authoritative records.
5. No projection may be required for replay correctness or runtime semantics.

## Scope

1. Document a stable **observability contract** over existing surfaces:
   - `/api/journal`,
   - `/api/debug/trace`,
   - CLI trace commands.
2. Define deterministic ordering and cursor semantics for consumers:
   - durable order = journal order,
   - resume rules and duplicate-handling rules are explicit.
3. Define correlation contract for agent session workflows:
   - required identity lineage fields (`session_id`, `run_id`, `turn_id`, `step_id`) where applicable,
   - correlation/causation lookup rules via existing hashes and trace outputs.
4. Optionally define a **host-local projected view** for ergonomics:
   - read-model only,
   - not an AIR/kernel schema requirement,
   - explicitly non-authoritative.
5. Validate one UI path and one headless path against the contract.

## Non-Goals

- New kernel primitives for streaming or event families.
- Treating a projected view as source of truth.
- Replacing raw journal/debug-trace APIs.
- Product-level UI design decisions.

## Deliverables

1. P2.4 contract doc defining:
   - ordering,
   - cursor/resume,
   - dedupe behavior,
   - correlation/causation fields,
   - source-pointer requirements.
2. Surface-level consistency pass:
   - align `from`/cursor semantics across HTTP and CLI docs/help text.
3. Contract notes for projected read-models (if exposed):
   - host/CLI/UI only,
   - include source linkage back to journal records.
4. Integration tests proving:
   - resume from cursor without durable duplication,
   - no missing required correlation fields in agent-session flows,
   - replay-stable consumer interpretation.

## Implementation Notes

- Reuse existing observability substrate from v0.9 Demiurge debug work (`journal-list`, `trace-get`, HTTP debug trace, CLI trace tools).
- Keep `roadmap/v0.10-agent-sdk/p9-stream.md` separate: transport can evolve independently from authoritative event semantics.
- If a projected endpoint is added, frame it as a convenience wrapper over journal-derived data, with explicit "non-authoritative" wording.
- Prefer incremental contract hardening over new schema families.
- Cursor contract for current journal APIs:
  - `from` is a journal cursor sequence.
  - Consumers resume by passing the last processed `seq` from the previous page.
  - Ordering is strictly by `seq` ascending.
  - Bootstrap note: on worlds without a baseline snapshot, `from=0` includes `seq=0`.

## Exit Criteria

1. A headless consumer can reconstruct agent run progression from journal/trace surfaces with documented cursor rules.
2. Resume-from-cursor behavior is deterministic and tested for duplicate handling.
3. Required correlation/lineage fields for agent session debugging are documented and present in integration coverage.
4. Replay of the same journal yields identical consumer-visible terminal interpretation.
5. At least one UI path and one headless harness operate on the documented contract without bespoke parsing assumptions.
6. No kernel/AIR additions are required to satisfy P2.4.
