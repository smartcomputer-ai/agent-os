# P2.2 LLM Boundary Issue: `sys/*` vs `aos.agent/*`

**Date**: 2026-02-13  
**Status**: Accepted; roadmap rebaseline applied on 2026-02-13

## Summary

There is a boundary conflict in current P2.2 direction:

- `sys/llm.generate@1` is a low-level built-in effect contract used by core runtime + host adapter.
- `aos.agent/*` is an SDK layer that should build on top of core primitives.

Current scaffold work accidentally blurred this boundary by defining `sys/Llm*` replacement schemas inside `crates/aos-agent-sdk` AIR assets. That makes the SDK appear authoritative for core `sys/*` contracts, which is architecturally backwards.

We need to define an API via sys/LLMGenrate, et al., that allows us to fully steer aos-llm, but is agent sdk agnostic. aos-agent-sdk needs to be build on that interface without pushing llm stuff down into sys. It is absolutely valid to expand sys/llmgenerate and the like to enable features for the agent sdk.


## Context

### Current architecture expectations

1. `sys/*` is core runtime surface:
   - built-in schemas/effects in `spec/defs/*`
   - shared low-level Rust types in core crates (`aos-effects`, `aos-host` adapters)
2. `aos.agent/*` is product/SDK layer:
   - session lifecycle, provider profile, lookup flow, loop state
   - should compile down to `sys/*` effects for execution

### What happened in scaffolding

In `crates/aos-agent-sdk/air/schemas.air.json`, we added:

- `sys/LlmRuntimeArgs@1`
- `sys/LlmGenerateParams@1`
- `sys/LlmGenerateReceipt@1`

That was done to reflect P2.2 schema drafts quickly, but it incorrectly places `sys/*` schema ownership under SDK assets.

## Why this is a problem

1. Layer inversion:
   - SDK (`aos.agent/*`) should not define core built-in `sys/*` contracts.
2. Coupling risk:
   - Any SDK iteration could accidentally become a runtime schema fork.
3. Migration ambiguity:
   - unclear whether source-of-truth for `sys/Llm*` is `spec/defs`, `aos-effects`, or SDK assets.
4. Operational risk:
   - host adapter behavior is tied to `sys/Llm*`; if SDK changes these independently, execution can drift from manifests/tests.

## Recommendation

Use strict two-layer separation.

1. Keep `sys/llm.generate@1` fully agent-agnostic.
2. Keep all agent semantics in `aos.agent/*` contracts.
3. Add an explicit deterministic translation boundary from agent runtime state to low-level `sys/LlmGenerateParams@1`.
4. Only evolve `sys/Llm*` in core sources (`spec/defs`, `aos-effects`, `aos-host`) as a platform-wide change, not in SDK-local AIR files.

## Recommended implementation model

### A. Contract ownership

1. Core owns:
   - `sys/llm.generate@1`
   - `sys/LlmGenerateParams@1`
   - `sys/LlmGenerateReceipt@1`
2. SDK owns:
   - `aos.agent/ProviderProfile@1`
   - `aos.agent/ProfileLookup*`
   - `aos.agent/LlmOutputEnvelope@1`
   - session/run/turn/step contracts

### B. Execution flow

1. Session/Profile reducers resolve immutable run config in `aos.agent/*` state.
2. Plan/reducer helper materializes `sys/LlmGenerateParams@1` from:
   - active run config (provider/model/reasoning/max tokens)
   - deterministic step context (message refs, tools, metadata, stop sequences, etc.)
3. Host executes `llm.generate` using the core adapter.
4. Receipt (`sys/LlmGenerateReceipt@1`) is ingested and mapped to `aos.agent/*` events/state.

### C. When to add a dedicated agent effect adapter

Only add `aos.agent/*` effect kind if required behavior cannot be represented in `sys/LlmGenerateParams@1` without polluting core contracts. Default should be reuse of `sys/llm.generate@1`.

## Immediate cleanup tasks

1. Remove `sys/Llm*` schema definitions from:
   - `crates/aos-agent-sdk/air/schemas.air.json`
2. Keep SDK manifest focused on `aos.agent/*` schemas/modules.
3. Add SDK-side mapper types/helpers:
   - example: `AgentLlmStepRequest -> sys::LlmGenerateParams`
4. If P2.2 requires richer low-level fields, implement those changes in core:
   - `spec/defs/builtin-schemas.air.json`
   - `aos-effects` `LlmGenerateParams/Receipt`
   - `aos-host` `LlmAdapter` mapping into `aos-llm::Request`

## Decision statement for roadmap docs

P2.2 should be interpreted as:

- "Evolve low-level LLM contract in core (`sys/*`)"
- and "add agent-level profile/lookup/output contracts in SDK (`aos.agent/*`)"

not as "define/replace `sys/*` contracts inside `aos-agent-sdk` assets".

## Resume checklist

1. Clean SDK AIR assets to remove `sys/Llm*` ownership.
2. Implement core-side `sys/Llm*` evolution in `spec/defs` + runtime crates.
3. Implement SDK mapper and reducer event flow on top.
4. Add integration tests proving:
   - agent layer remains provider-profile aware,
   - core adapter remains agent-agnostic,
   - replay determinism preserved.
