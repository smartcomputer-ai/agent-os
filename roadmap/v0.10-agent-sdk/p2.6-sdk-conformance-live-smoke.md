# P2.6: SDK Conformance Harness and Live LLM Smoke

**Stage**: P2.6  
**Status**: In progress (deterministic conformance slice landed on 2026-02-14)  
**Depends on**: P2.1, P2.2, P2.3, P2.4, P2.5

## Purpose

Close P2 with behavioral proof for Agent SDK flows in `crates/aos-smoke`, while keeping core trace/kernel conformance in the core lane.

Demiurge migration is explicitly deferred to P3 (`roadmap/v0.10-agent-sdk/p3-demiurge-refactor.md`).

## Implementation Progress (2026-02-14)

Completed:

1. Fixture taxonomy and CLI lane split were updated:
   - core/kernel/system lane is now `00`-`19`,
   - Agent SDK lane is now `20+`,
   - `aos-smoke all` runs core lane only,
   - `aos-smoke all-agent` runs Agent SDK lane only.
2. Fixture renumbering and ownership alignment landed:
   - `10-agent-session` moved to `20-agent-session`,
   - `11-agent-failure-classification` moved/renamed to `10-trace-failure-classification`.
3. Deterministic Agent SDK conformance coverage is active in `20-agent-session`:
   - no-tool completion,
   - tool batch roundtrip and settle ordering,
   - high-contention fan-out/fan-in behavior,
   - cancellation with stale late receipts,
   - loop-cap (`max_steps_per_run`) failure path,
   - unknown provider/model run-start rejection without state mutation,
   - immutable `active_run_config` during run and provider/model updates across runs.
4. Failure-classification conformance landed as a core trace fixture in `10-trace-failure-classification`:
   - `policy_denied`,
   - `capability_denied`,
   - `adapter_timeout`,
   - `adapter_error`.
5. Validation is done through existing trace surfaces, not new primitives:
   - shared host trace query/diagnosis helpers are reused by daemon/CLI/smoke paths,
   - fixture assertions are based on `trace_get` + `trace_diagnose` output.
6. Roadmap/docs references were updated to the new numbering (`20-agent-session`, `10-trace-failure-classification`).
7. Opt-in live Agent SDK smoke command landed in `aos-smoke`:
   - `aos-smoke chat-live` (default OpenAI Responses),
   - `aos-smoke chat-live --provider anthropic`,
   - flow uses secret-injected API keys (`defsecret`-based),
   - validates tool orchestration (`echo_payload`, `sum_pair`) + follow-up turn,
   - ends with replay verification.

## Remaining Scope

1. Optional live-provider SDK lane follow-up:
   - current smoke lane covers `openai/*` and `anthropic/*` via `chat-live`,
   - add `openai-compatible/*` coverage if required in this stage.
2. Add repository-level boundary guard:
   - confirm no SDK-local ownership of `sys/Llm*` schema definitions.
3. Publish final P2 closure report once live lane + boundary guard are landed.

## Non-Goals

- Demiurge migration/cutover (handled in P3).
- Parent/child delegation protocol and sample world.
- Output-bounding/truncation machinery deferred from P2.3.
- Requiring live-provider lane for deterministic CI replay gates.

## Deliverables

1. Updated `aos-smoke` fixture taxonomy showing `00`-`19` core vs `20+` SDK conformance.
2. SDK conformance fixture suite in `20+` with deterministic replay checks.
3. Live-provider SDK smoke profile documented with required env/credentials and provider matrix.
4. Repo conformance check for `sys/Llm*` ownership boundary.
5. Final P2 closure report mapped to stage exit gates.

## Implementation Notes

- Use `crates/aos-smoke` as the only e2e runner for SDK conformance.
- Keep deterministic lane as the release/CI gate.
- Keep live lane opt-in and operationally focused (provider interop), not replay-equivalence.
- Reuse existing trace/debug surfaces for validation evidence (`trace-get`, `trace-diagnose`, terminal classification).
- Include explicit assertions for `RunRequested -> RunStarted -> fixed active_run_config` semantics.

## Exit Criteria

1. Deterministic SDK conformance lane (`20+`) passes with replay parity.
2. Core fixture lane (`00`-`19`) remains green after SDK conformance additions.
3. Core trace classification fixture (`10-trace-failure-classification`) remains green in `all`.
4. Live-provider SDK lane exists, is documented, and can be run opt-in against required provider families.
5. Unknown provider/model deterministically fails run start with no partial activation.
6. Provider/model updates affect only subsequent runs; active runs keep immutable `active_run_config`.
7. Repository checks confirm `sys/Llm*` ownership stays in core crates/spec assets, not SDK AIR assets.
8. P2 closure report is published and all prior stage exit criteria remain green.
