# P2.6: SDK Conformance Harness and Live LLM Smoke

**Stage**: P2.6  
**Status**: Proposed  
**Depends on**: P2.1, P2.2, P2.3, P2.4, P2.5

## Purpose

Close P2 with behavioral proof for Agent SDK flows in `crates/aos-smoke`, including real-provider checks.

Demiurge migration is explicitly deferred to P3 (`roadmap/v0.10-agent-sdk/p3-demiurge-refactor.md`).

## Scope

1. Define fixture partitioning in `crates/aos-smoke`:
   - **Core kernel/system fixtures**: `00`-`09`.
   - **Agent SDK conformance fixtures**: `10+`.
   - Keep one runner (`aos-smoke`) and make fixture grouping visible in fixture docs and CLI output.
2. Define deterministic SDK conformance matrix (`10+`, CI-gated):
   - no-tool completion,
   - tool call roundtrip,
   - parallel tool fan-out/fan-in,
   - loop-cap detection (`max_steps_per_run`),
   - cancellation with stale late receipts,
   - policy/cap denial classification,
   - adapter timeout/error classification,
   - unknown provider/model start rejection,
   - provider/model change across runs with no in-run drift (`active_run_config` immutable per run).
3. Add replay-oriented assertions for deterministic lane:
   - replay from genesis,
   - byte-identical terminal snapshots/classification.
4. Add optional live-provider SDK lane (`10+`, opt-in):
   - provider families: `openai/*`, `anthropic/*`, `openai-compatible/*`,
   - at least one no-tool and one tool-call scenario per provider family,
   - wiring/interop verification only (not replay-parity gating).
5. Add repository-level boundary guard:
   - confirm no SDK-local ownership of `sys/Llm*` schema definitions.

## Non-Goals

- Demiurge migration/cutover (handled in P3).
- Parent/child delegation protocol and sample world.
- Output-bounding/truncation machinery deferred from P2.3.
- Requiring live-provider lane for deterministic CI replay gates.

## Deliverables

1. Updated `aos-smoke` fixture taxonomy showing `00`-`09` core vs `10+` SDK conformance.
2. SDK conformance fixture suite in `10+` with deterministic replay checks.
3. Live-provider SDK smoke profile documented with required env/credentials and provider matrix.
4. Repo conformance check for `sys/Llm*` ownership boundary.
5. Final P2 closure report mapped to stage exit gates.

## Implementation Notes

- Use `crates/aos-smoke` as the only e2e runner for SDK conformance.
- Keep deterministic lane as the release/CI gate.
- Keep live lane opt-in and operationally focused (provider interop), not replay-equivalence.
- Reuse existing trace/debug surfaces for validation evidence (`trace-get`, `trace-diagnose`, terminal classification).
- Include explicit assertions for `RunRequested -> RunStarted -> fixed active_run_config` semantics.

## Exit Criteria

1. Deterministic SDK conformance lane (`10+`) passes with replay parity.
2. Core fixture lane (`00`-`09`) remains green after SDK conformance additions.
3. Live-provider SDK lane exists, is documented, and can be run opt-in against required provider families.
4. Unknown provider/model deterministically fails run start with no partial activation.
5. Provider/model updates affect only subsequent runs; active runs keep immutable `active_run_config`.
6. Repository checks confirm `sys/Llm*` ownership stays in core crates/spec assets, not SDK AIR assets.
7. P2 closure report is published and all prior stage exit criteria remain green.
