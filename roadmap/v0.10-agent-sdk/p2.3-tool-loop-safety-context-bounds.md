# P2.3: Tool Loop Safety, Limits, and Context Bounds

**Stage**: P2.3  
**Status**: Complete (MVP slice verified on 2026-02-14)  
**Depends on**: P2.1, P2.2

## Purpose

Keep only the minimum safety needed to ship a first working agent loop.

P2.1 remains the source of truth for lease, batch settle, and pause/resume/cancel semantics.  
This stage is intentionally thin and avoids heavy policy until the base agent flow is stable.

## Implementation Progress (2026-02-14)

Completed:

1. Added minimal runtime limits contract in SDK helpers:
   - `SessionRuntimeLimits { max_steps_per_run: Option<u64> }`.
2. Added deterministic step-cap enforcement path:
   - `apply_session_event_with_limits`,
   - `apply_session_event_with_catalog_and_limits`.
3. Added per-run deterministic step counter in session state:
   - `active_run_step_count`.
4. Added SDK unit coverage for cap-triggered fail-and-clear behavior.
5. Expanded smoke fixture `10-agent-session` with a runaway loop scenario proving deterministic stop on step-cap breach, while preserving replay parity.

## Scope

1. Keep one emergency runaway guard:
   - `max_steps_per_run` only.
2. Keep current P2.1 semantics as-is:
   - lease heartbeat/expiry path,
   - deterministic batch settle/fan-in.
3. Keep tool output contract unchanged for MVP:
   - no truncation pipeline changes,
   - no dual-channel output split.

## Deferred (Post-MVP)

1. Multi-dimensional limits:
   - max turns,
   - max tool rounds per turn,
   - max tool calls per step,
   - max in-flight effects backpressure.
2. Loop signature detection and automatic loop policy actions.
3. Context pressure thresholds/events.
4. Tool output bounding/truncation metadata:
   - `operator_output_ref`,
   - `model_output_ref`,
   - `truncation_meta`.
5. Any token/cost budgeting policy.

## Non-Goals

- SSE transport/protocol details.
- Full failure taxonomy ownership rules (handled in P2.5).

## Deliverables

1. Minimal SDK/runtime setting for `max_steps_per_run` (optional, relaxed default).
2. Reducer helper for deterministic step-cap enforcement.
3. One smoke scenario proving runaway loop is stopped deterministically.
4. Explicit deferred-list documentation to avoid accidental scope creep.

## Implementation Notes

- Default behavior should be permissive so normal agent runs are not blocked.
- Step-cap should be high and used as a circuit breaker, not day-to-day control.
- Preserve reducer/plan boundaries:
  - reducer decides stop transition on cap breach,
  - plans/adapters remain effect executors.
- Do not add truncation, context-pressure, or loop-signature machinery in this slice.

## Exit Criteria

1. Happy-path tool-using agent run works with no new operational friction.
2. Runaway loop can be deterministically stopped by `max_steps_per_run`.
3. Replay parity remains intact for both normal and cap-triggered runs.
4. Deferred items stay deferred; no hidden partial implementations land in MVP.
