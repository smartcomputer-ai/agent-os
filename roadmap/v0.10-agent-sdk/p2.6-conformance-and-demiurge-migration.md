# P2.6: Conformance Harness and Demiurge Migration

**Stage**: P2.6  
**Status**: Proposed  
**Depends on**: P2.1, P2.2, P2.3, P2.4, P2.5

## Purpose

Close P2 with behavioral proof and real-app migration, not only schema/API availability.

This stage resolves concerns #8 and #9.

## Scope

1. Define conformance matrix:
   - provider profiles: `openai-responses`, `anthropic-messages`, `openai-compatible`.
   - scenarios:
     - no-tool completion,
     - tool call roundtrip,
     - parallel tool fan-out/fan-in,
     - output bounding,
     - loop detection,
     - cancellation,
     - policy/cap denial,
     - adapter timeout/error,
     - parent/child session lifecycle,
     - unknown provider profile id,
     - profile change across runs with no in-run drift.
2. Add replay-oriented end-to-end assertions:
   - journal replay from genesis,
   - byte-identical terminal state snapshots.
3. Execute conformance via `crates/aos-smoke` as the single e2e runner:
   - deterministic lane (default/CI),
   - optional live-provider lane (real LLM calls, opt-in).
4. Migrate Demiurge core flow to SDK contracts:
   - `demiurge/*` to `aos.agent/*` mapping,
   - keep short-term adapters only where needed.
5. Ship at least one reusable sample world for parent/child orchestration.

## Non-Goals

- Full removal of every legacy alias in same commit.
- Universe-level cross-world orchestration protocol.

## Deliverables

1. Conformance fixture suite in `crates/aos-smoke` (single e2e runner for SDK flows).
2. Migration plan and cutover checklist for `apps/demiurge`.
3. One headless sample world and one delegation sample world.
4. Final P2 closure report against stage exit gates.
5. Optional live-provider smoke job/profile documented with required env/credentials and provider matrix.

## Implementation Notes

- Use existing Demiurge e2e patterns (`trace-get`, receipt/terminal checks) as starting fixtures.
- Keep replay-or-die as non-negotiable acceptance criterion.
- Deterministic lane is required for CI gating and uses reproducible adapters/fixtures.
- Live-provider lane is opt-in and validates real-provider interop, but is not used for replay-parity gating.
- Include profile-catalog reducer fixtures proving event-driven lookup (`ProfileLookupRequested -> ProfileLookupResolved|Failed`) before `RunStarted`.

## Exit Criteria

1. Conformance matrix passes for all required provider profiles and scenarios.
2. Demiurge runs on core SDK contracts with no bespoke loop semantics remaining in reducer state machine.
3. Parent/child session orchestration sample passes deterministic integration and replay tests.
4. All prior stage exit criteria remain green after migration.
5. P2 marked complete only after closure report is published.
6. `aos-smoke` deterministic lane is green in CI; live-provider lane is available and documented as opt-in.
7. Unknown `provider_profile_id` deterministically fails run start through typed lookup-failure path (no partial run activation).
8. Profile updates only affect subsequent runs; active runs keep immutable `active_run_config` values through completion/cancel.
