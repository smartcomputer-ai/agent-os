[
  {
    "$kind": "defplan",
    "name": "aos.agent/core_workspace_sync@1",
    "input": "aos.agent/WorkspaceSyncRequested@1",
    "output": "aos.agent/SessionEventKind@1",
    "steps": [
      {
        "id": "assign_prompt_input",
        "op": "assign",
        "expr": {
          "record": {
            "workspace_binding": { "ref": "@plan.input.workspace_binding" },
            "prompt_pack": { "ref": "@plan.input.prompt_pack" },
            "tool_catalog": { "null": {} },
            "known_version": { "ref": "@plan.input.known_version" }
          }
        },
        "bind": { "as": "prompt_input" }
      },
      {
        "id": "assign_tool_input",
        "op": "assign",
        "expr": {
          "record": {
            "workspace_binding": { "ref": "@plan.input.workspace_binding" },
            "prompt_pack": { "null": {} },
            "tool_catalog": { "ref": "@plan.input.tool_catalog" },
            "known_version": { "ref": "@plan.input.known_version" }
          }
        },
        "bind": { "as": "tool_input" }
      },
      {
        "id": "spawn_prompt_sync",
        "op": "spawn_plan",
        "plan": "aos.agent/core_prompt_sync_from_workspace@1",
        "input": { "ref": "@var:prompt_input" },
        "bind": { "handle_as": "prompt_handle" }
      },
      {
        "id": "await_prompt_sync",
        "op": "await_plan",
        "for": { "ref": "@var:prompt_handle" },
        "bind": { "as": "prompt_result" }
      },
      {
        "id": "assign_prompt_result_tag",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [{ "ref": "@var:prompt_result" }, { "text": "$tag" }]
        },
        "bind": { "as": "prompt_result_tag" }
      },
      {
        "id": "assign_prompt_event_kind",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [{ "ref": "@var:prompt_result" }, { "text": "$value" }]
        },
        "bind": { "as": "prompt_event_kind" }
      },
      {
        "id": "assign_prompt_event_tag",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [{ "ref": "@var:prompt_event_kind" }, { "text": "$tag" }]
        },
        "bind": { "as": "prompt_event_tag" }
      },
      {
        "id": "spawn_tool_sync",
        "op": "spawn_plan",
        "plan": "aos.agent/core_tool_catalog_sync_from_workspace@1",
        "input": { "ref": "@var:tool_input" },
        "bind": { "handle_as": "tool_handle" }
      },
      {
        "id": "await_tool_sync",
        "op": "await_plan",
        "for": { "ref": "@var:tool_handle" },
        "bind": { "as": "tool_result" }
      },
      {
        "id": "assign_tool_result_tag",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [{ "ref": "@var:tool_result" }, { "text": "$tag" }]
        },
        "bind": { "as": "tool_result_tag" }
      },
      {
        "id": "assign_tool_event_kind",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [{ "ref": "@var:tool_result" }, { "text": "$value" }]
        },
        "bind": { "as": "tool_event_kind" }
      },
      {
        "id": "assign_tool_event_tag",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [{ "ref": "@var:tool_event_kind" }, { "text": "$tag" }]
        },
        "bind": { "as": "tool_event_tag" }
      },
      {
        "id": "finish_prompt_spawn_failed",
        "op": "end",
        "result": {
          "variant": {
            "tag": "WorkspaceSyncFailed",
            "value": {
              "record": {
                "workspace": {
                  "op": "get",
                  "args": [
                    { "ref": "@plan.input.workspace_binding" },
                    { "text": "workspace" }
                  ]
                },
                "stage": { "text": "workspace_sync_core_prompt" },
                "detail": {
                  "op": "get",
                  "args": [
                    {
                      "op": "get",
                      "args": [{ "ref": "@var:prompt_result" }, { "text": "$value" }]
                    },
                    { "text": "message" }
                  ]
                }
              }
            }
          }
        }
      },
      {
        "id": "finish_tool_spawn_failed",
        "op": "end",
        "result": {
          "variant": {
            "tag": "WorkspaceSyncFailed",
            "value": {
              "record": {
                "workspace": {
                  "op": "get",
                  "args": [
                    { "ref": "@plan.input.workspace_binding" },
                    { "text": "workspace" }
                  ]
                },
                "stage": { "text": "workspace_sync_core_tool" },
                "detail": {
                  "op": "get",
                  "args": [
                    {
                      "op": "get",
                      "args": [{ "ref": "@var:tool_result" }, { "text": "$value" }]
                    },
                    { "text": "message" }
                  ]
                }
              }
            }
          }
        }
      },
      {
        "id": "finish_prompt_event",
        "op": "end",
        "result": { "ref": "@var:prompt_event_kind" }
      },
      {
        "id": "assign_prompt_ready_value",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [{ "ref": "@var:prompt_event_kind" }, { "text": "$value" }]
        },
        "bind": { "as": "prompt_ready_value" }
      },
      {
        "id": "assign_tool_ready_value",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [{ "ref": "@var:tool_event_kind" }, { "text": "$value" }]
        },
        "bind": { "as": "tool_ready_value" }
      },
      {
        "id": "assign_prompt_snapshot",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [{ "ref": "@var:prompt_ready_value" }, { "text": "snapshot" }]
        },
        "bind": { "as": "prompt_snapshot" }
      },
      {
        "id": "assign_tool_snapshot",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [{ "ref": "@var:tool_ready_value" }, { "text": "snapshot" }]
        },
        "bind": { "as": "tool_snapshot" }
      },
      {
        "id": "finish_snapshot_ready",
        "op": "end",
        "result": {
          "variant": {
            "tag": "WorkspaceSnapshotReady",
            "value": {
              "record": {
                "snapshot": {
                  "record": {
                    "workspace": {
                      "op": "get",
                      "args": [{ "ref": "@var:prompt_snapshot" }, { "text": "workspace" }]
                    },
                    "version": {
                      "op": "get",
                      "args": [{ "ref": "@var:prompt_snapshot" }, { "text": "version" }]
                    },
                    "root_hash": {
                      "op": "get",
                      "args": [{ "ref": "@var:prompt_snapshot" }, { "text": "root_hash" }]
                    },
                    "index_ref": {
                      "op": "get",
                      "args": [{ "ref": "@var:prompt_snapshot" }, { "text": "index_ref" }]
                    },
                    "prompt_pack": {
                      "op": "get",
                      "args": [{ "ref": "@var:prompt_snapshot" }, { "text": "prompt_pack" }]
                    },
                    "tool_catalog": {
                      "op": "get",
                      "args": [{ "ref": "@var:tool_snapshot" }, { "text": "tool_catalog" }]
                    },
                    "prompt_pack_ref": {
                      "op": "get",
                      "args": [{ "ref": "@var:prompt_snapshot" }, { "text": "prompt_pack_ref" }]
                    },
                    "tool_catalog_ref": {
                      "op": "get",
                      "args": [{ "ref": "@var:tool_snapshot" }, { "text": "tool_catalog_ref" }]
                    }
                  }
                },
                "prompt_pack_bytes": {
                  "op": "get",
                  "args": [
                    { "ref": "@var:prompt_ready_value" },
                    { "text": "prompt_pack_bytes" }
                  ]
                },
                "tool_catalog_bytes": {
                  "op": "get",
                  "args": [
                    { "ref": "@var:tool_ready_value" },
                    { "text": "tool_catalog_bytes" }
                  ]
                }
              }
            }
          }
        }
      },
      {
        "id": "finish_compose_mismatch",
        "op": "end",
        "result": {
          "variant": {
            "tag": "WorkspaceSyncFailed",
            "value": {
              "record": {
                "workspace": {
                  "op": "get",
                  "args": [
                    { "ref": "@plan.input.workspace_binding" },
                    { "text": "workspace" }
                  ]
                },
                "stage": { "text": "workspace_sync_core_compose" },
                "detail": {
                  "op": "concat",
                  "args": [
                    { "text": "prompt_tag=" },
                    {
                      "op": "concat",
                      "args": [
                        { "ref": "@var:prompt_event_tag" },
                        {
                          "op": "concat",
                          "args": [
                            { "text": ",tool_tag=" },
                            { "ref": "@var:tool_event_tag" }
                          ]
                        }
                      ]
                    }
                  ]
                }
              }
            }
          }
        }
      }
    ],
    "edges": [
      { "from": "assign_prompt_input", "to": "assign_tool_input" },
      { "from": "assign_tool_input", "to": "spawn_prompt_sync" },
      { "from": "spawn_prompt_sync", "to": "await_prompt_sync" },
      { "from": "await_prompt_sync", "to": "assign_prompt_result_tag" },
      {
        "from": "assign_prompt_result_tag",
        "to": "finish_prompt_spawn_failed",
        "when": {
          "op": "ne",
          "args": [{ "ref": "@var:prompt_result_tag" }, { "text": "Ok" }]
        }
      },
      {
        "from": "assign_prompt_result_tag",
        "to": "assign_prompt_event_kind",
        "when": {
          "op": "eq",
          "args": [{ "ref": "@var:prompt_result_tag" }, { "text": "Ok" }]
        }
      },
      { "from": "assign_prompt_event_kind", "to": "assign_prompt_event_tag" },
      { "from": "assign_prompt_event_tag", "to": "spawn_tool_sync" },
      { "from": "spawn_tool_sync", "to": "await_tool_sync" },
      { "from": "await_tool_sync", "to": "assign_tool_result_tag" },
      {
        "from": "assign_tool_result_tag",
        "to": "finish_tool_spawn_failed",
        "when": {
          "op": "ne",
          "args": [{ "ref": "@var:tool_result_tag" }, { "text": "Ok" }]
        }
      },
      {
        "from": "assign_tool_result_tag",
        "to": "assign_tool_event_kind",
        "when": {
          "op": "eq",
          "args": [{ "ref": "@var:tool_result_tag" }, { "text": "Ok" }]
        }
      },
      { "from": "assign_tool_event_kind", "to": "assign_tool_event_tag" },
      {
        "from": "assign_tool_event_tag",
        "to": "finish_prompt_event",
        "when": {
          "op": "and",
          "args": [
            {
              "op": "eq",
              "args": [
                { "ref": "@var:prompt_event_tag" },
                { "text": "WorkspaceSyncUnchanged" }
              ]
            },
            {
              "op": "eq",
              "args": [
                { "ref": "@var:tool_event_tag" },
                { "text": "WorkspaceSyncUnchanged" }
              ]
            }
          ]
        }
      },
      {
        "from": "assign_tool_event_tag",
        "to": "assign_prompt_ready_value",
        "when": {
          "op": "and",
          "args": [
            {
              "op": "eq",
              "args": [
                { "ref": "@var:prompt_event_tag" },
                { "text": "WorkspaceSnapshotReady" }
              ]
            },
            {
              "op": "eq",
              "args": [
                { "ref": "@var:tool_event_tag" },
                { "text": "WorkspaceSnapshotReady" }
              ]
            }
          ]
        }
      },
      {
        "from": "assign_tool_event_tag",
        "to": "finish_compose_mismatch",
        "when": {
          "op": "or",
          "args": [
            {
              "op": "ne",
              "args": [{ "ref": "@var:prompt_event_tag" }, { "ref": "@var:tool_event_tag" }]
            },
            {
              "op": "and",
              "args": [
                {
                  "op": "ne",
                  "args": [
                    { "ref": "@var:prompt_event_tag" },
                    { "text": "WorkspaceSyncUnchanged" }
                  ]
                },
                {
                  "op": "ne",
                  "args": [
                    { "ref": "@var:prompt_event_tag" },
                    { "text": "WorkspaceSnapshotReady" }
                  ]
                }
              ]
            }
          ]
        }
      },
      { "from": "assign_prompt_ready_value", "to": "assign_tool_ready_value" },
      { "from": "assign_tool_ready_value", "to": "assign_prompt_snapshot" },
      { "from": "assign_prompt_snapshot", "to": "assign_tool_snapshot" },
      { "from": "assign_tool_snapshot", "to": "finish_snapshot_ready" }
    ],
    "required_caps": [],
    "allowed_effects": []
  }
]
