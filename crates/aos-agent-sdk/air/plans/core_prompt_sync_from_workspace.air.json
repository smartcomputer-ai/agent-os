[
  {
    "$kind": "defplan",
    "name": "aos.agent/core_prompt_sync_from_workspace@1",
    "input": "aos.agent/WorkspaceSyncRequested@1",
    "output": "aos.agent/SessionEventKind@1",
    "steps": [
      {
        "id": "emit_workspace_resolve",
        "op": "emit_effect",
        "kind": "workspace.resolve",
        "params": {
          "record": {
            "workspace": {
              "op": "get",
              "args": [
                { "ref": "@plan.input.workspace_binding" },
                { "text": "workspace" }
              ]
            },
            "version": {
              "op": "get",
              "args": [
                { "ref": "@plan.input.workspace_binding" },
                { "text": "version" }
              ]
            }
          }
        },
        "cap": "cap_workspace",
        "bind": { "effect_id_as": "workspace_resolve" }
      },
      {
        "id": "await_workspace_resolve",
        "op": "await_receipt",
        "for": { "ref": "@var:workspace_resolve" },
        "bind": { "as": "workspace_resolve_receipt" }
      },
      {
        "id": "assign_workspace_root",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            { "ref": "@var:workspace_resolve_receipt" },
            { "text": "root_hash" }
          ]
        },
        "bind": { "as": "workspace_root" }
      },
      {
        "id": "assign_resolved_version",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            { "ref": "@var:workspace_resolve_receipt" },
            { "text": "resolved_version" }
          ]
        },
        "bind": { "as": "resolved_version" }
      },
      {
        "id": "finish_unchanged",
        "op": "end",
        "result": {
          "variant": {
            "tag": "WorkspaceSyncUnchanged",
            "value": {
              "record": {
                "workspace": {
                  "op": "get",
                  "args": [
                    { "ref": "@plan.input.workspace_binding" },
                    { "text": "workspace" }
                  ]
                },
                "version": { "ref": "@var:resolved_version" }
              }
            }
          }
        }
      },
      {
        "id": "emit_workspace_read_index",
        "op": "emit_effect",
        "kind": "workspace.read_ref",
        "params": {
          "record": {
            "root_hash": { "ref": "@var:workspace_root" },
            "path": { "text": "agent.workspace.json" }
          }
        },
        "cap": "cap_workspace",
        "bind": { "effect_id_as": "workspace_read_index" }
      },
      {
        "id": "await_workspace_read_index",
        "op": "await_receipt",
        "for": { "ref": "@var:workspace_read_index" },
        "bind": { "as": "workspace_read_index_receipt" }
      },
      {
        "id": "assign_index_ref",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            { "ref": "@var:workspace_read_index_receipt" },
            { "text": "hash" }
          ]
        },
        "bind": { "as": "index_ref" }
      },
      {
        "id": "assign_prompt_pack_ref_null",
        "op": "assign",
        "expr": { "null": {} },
        "bind": { "as": "prompt_pack_ref" }
      },
      {
        "id": "assign_prompt_pack_bytes_null",
        "op": "assign",
        "expr": { "null": {} },
        "bind": { "as": "prompt_pack_bytes" }
      },
      {
        "id": "emit_workspace_read_prompt_pack",
        "op": "emit_effect",
        "kind": "workspace.read_ref",
        "params": {
          "record": {
            "root_hash": { "ref": "@var:workspace_root" },
            "path": {
              "op": "concat",
              "args": [
                { "text": "prompts/packs/" },
                {
                  "op": "concat",
                  "args": [
                    { "ref": "@plan.input.prompt_pack" },
                    { "text": ".json" }
                  ]
                }
              ]
            }
          }
        },
        "cap": "cap_workspace",
        "bind": { "effect_id_as": "workspace_read_prompt_pack" }
      },
      {
        "id": "await_workspace_read_prompt_pack",
        "op": "await_receipt",
        "for": { "ref": "@var:workspace_read_prompt_pack" },
        "bind": { "as": "workspace_read_prompt_pack_receipt" }
      },
      {
        "id": "assign_prompt_pack_ref",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            { "ref": "@var:workspace_read_prompt_pack_receipt" },
            { "text": "hash" }
          ]
        },
        "bind": { "as": "prompt_pack_ref" }
      },
      {
        "id": "emit_workspace_read_prompt_pack_bytes",
        "op": "emit_effect",
        "kind": "workspace.read_bytes",
        "params": {
          "record": {
            "root_hash": { "ref": "@var:workspace_root" },
            "path": {
              "op": "concat",
              "args": [
                { "text": "prompts/packs/" },
                {
                  "op": "concat",
                  "args": [
                    { "ref": "@plan.input.prompt_pack" },
                    { "text": ".json" }
                  ]
                }
              ]
            }
          }
        },
        "cap": "cap_workspace",
        "bind": { "effect_id_as": "workspace_read_prompt_pack_bytes" }
      },
      {
        "id": "await_workspace_read_prompt_pack_bytes",
        "op": "await_receipt",
        "for": { "ref": "@var:workspace_read_prompt_pack_bytes" },
        "bind": { "as": "workspace_read_prompt_pack_bytes_receipt" }
      },
      {
        "id": "assign_prompt_pack_bytes",
        "op": "assign",
        "expr": { "ref": "@var:workspace_read_prompt_pack_bytes_receipt" },
        "bind": { "as": "prompt_pack_bytes" }
      },
      {
        "id": "assign_tool_catalog_ref_null",
        "op": "assign",
        "expr": { "null": {} },
        "bind": { "as": "tool_catalog_ref" }
      },
      {
        "id": "assign_tool_catalog_bytes_null",
        "op": "assign",
        "expr": { "null": {} },
        "bind": { "as": "tool_catalog_bytes" }
      },
      {
        "id": "finish_snapshot_ready",
        "op": "end",
        "result": {
          "variant": {
            "tag": "WorkspaceSnapshotReady",
            "value": {
              "record": {
                "snapshot": {
                  "record": {
                    "workspace": {
                      "op": "get",
                      "args": [
                        { "ref": "@plan.input.workspace_binding" },
                        { "text": "workspace" }
                      ]
                    },
                    "version": { "ref": "@var:resolved_version" },
                    "root_hash": { "ref": "@var:workspace_root" },
                    "index_ref": { "ref": "@var:index_ref" },
                    "prompt_pack": { "ref": "@plan.input.prompt_pack" },
                    "tool_catalog": { "null": {} },
                    "prompt_pack_ref": { "ref": "@var:prompt_pack_ref" },
                    "tool_catalog_ref": { "ref": "@var:tool_catalog_ref" }
                  }
                },
                "prompt_pack_bytes": { "ref": "@var:prompt_pack_bytes" },
                "tool_catalog_bytes": { "ref": "@var:tool_catalog_bytes" }
              }
            }
          }
        }
      }
    ],
    "edges": [
      { "from": "emit_workspace_resolve", "to": "await_workspace_resolve" },
      { "from": "await_workspace_resolve", "to": "assign_workspace_root" },
      { "from": "assign_workspace_root", "to": "assign_resolved_version" },
      {
        "from": "assign_resolved_version",
        "to": "finish_unchanged",
        "when": {
          "op": "and",
          "args": [
            {
              "op": "ne",
              "args": [
                { "ref": "@plan.input.known_version" },
                { "null": {} }
              ]
            },
            {
              "op": "eq",
              "args": [
                { "ref": "@plan.input.known_version" },
                { "ref": "@var:resolved_version" }
              ]
            }
          ]
        }
      },
      {
        "from": "assign_resolved_version",
        "to": "emit_workspace_read_index",
        "when": {
          "op": "or",
          "args": [
            {
              "op": "eq",
              "args": [
                { "ref": "@plan.input.known_version" },
                { "null": {} }
              ]
            },
            {
              "op": "ne",
              "args": [
                { "ref": "@plan.input.known_version" },
                { "ref": "@var:resolved_version" }
              ]
            }
          ]
        }
      },
      { "from": "emit_workspace_read_index", "to": "await_workspace_read_index" },
      { "from": "await_workspace_read_index", "to": "assign_index_ref" },
      {
        "from": "assign_index_ref",
        "to": "emit_workspace_read_prompt_pack",
        "when": {
          "op": "ne",
          "args": [
            { "ref": "@plan.input.prompt_pack" },
            { "null": {} }
          ]
        }
      },
      {
        "from": "assign_index_ref",
        "to": "assign_prompt_pack_ref_null",
        "when": {
          "op": "eq",
          "args": [
            { "ref": "@plan.input.prompt_pack" },
            { "null": {} }
          ]
        }
      },
      {
        "from": "emit_workspace_read_prompt_pack",
        "to": "await_workspace_read_prompt_pack"
      },
      {
        "from": "await_workspace_read_prompt_pack",
        "to": "assign_prompt_pack_ref"
      },
      {
        "from": "assign_prompt_pack_ref",
        "to": "emit_workspace_read_prompt_pack_bytes"
      },
      {
        "from": "emit_workspace_read_prompt_pack_bytes",
        "to": "await_workspace_read_prompt_pack_bytes"
      },
      {
        "from": "await_workspace_read_prompt_pack_bytes",
        "to": "assign_prompt_pack_bytes"
      },
      {
        "from": "assign_prompt_pack_ref_null",
        "to": "assign_prompt_pack_bytes_null"
      },
      {
        "from": "assign_prompt_pack_bytes",
        "to": "assign_tool_catalog_ref_null"
      },
      {
        "from": "assign_prompt_pack_bytes_null",
        "to": "assign_tool_catalog_ref_null"
      },
      {
        "from": "assign_tool_catalog_ref_null",
        "to": "assign_tool_catalog_bytes_null"
      },
      {
        "from": "assign_tool_catalog_bytes_null",
        "to": "finish_snapshot_ready"
      }
    ],
    "required_caps": ["cap_workspace"],
    "allowed_effects": [
      "workspace.resolve",
      "workspace.read_ref",
      "workspace.read_bytes"
    ]
  }
]
