[
  {
    "$kind": "defplan",
    "name": "demo/core_runtime_hardening@1",
    "input": "demo/RuntimeHardeningStart@1",
    "steps": [
      {
        "id": "spawn_gate",
        "op": "spawn_plan",
        "plan": "demo/_internal_wait_approval@1",
        "input": { "ref": "@plan.input" },
        "bind": { "handle_as": "gate_handle" }
      },
      {
        "id": "await_gate",
        "op": "await_plan",
        "for": { "ref": "@var:gate_handle" },
        "bind": { "as": "gate_result" }
      },
      {
        "id": "spawn_workers",
        "op": "spawn_for_each",
        "plan": "demo/_internal_worker_fetch@1",
        "inputs": {
          "op": "get",
          "args": [
            { "ref": "@plan.input" },
            { "text": "urls" }
          ]
        },
        "max_fanout": 8,
        "bind": { "handles_as": "worker_handles" }
      },
      {
        "id": "await_workers",
        "op": "await_plans_all",
        "handles": { "ref": "@var:worker_handles" },
        "bind": { "results_as": "worker_results" }
      },
      {
        "id": "raise_completed",
        "op": "raise_event",
        "event": "demo/FlowCompleted@1",
        "value": {
          "record": {
            "request_id": {
              "op": "get",
              "args": [
                { "ref": "@plan.input" },
                { "text": "request_id" }
              ]
            },
            "worker_count": {
              "op": "len",
              "args": [
                { "ref": "@var:worker_results" }
              ]
            }
          }
        }
      },
      {
        "id": "finish",
        "op": "end"
      }
    ],
    "edges": [
      { "from": "spawn_gate", "to": "await_gate" },
      { "from": "await_gate", "to": "spawn_workers" },
      { "from": "spawn_workers", "to": "await_workers" },
      { "from": "await_workers", "to": "raise_completed" },
      { "from": "raise_completed", "to": "finish" }
    ],
    "required_caps": [],
    "allowed_effects": []
  },
  {
    "$kind": "defplan",
    "name": "demo/_internal_wait_approval@1",
    "input": "demo/RuntimeHardeningStart@1",
    "steps": [
      {
        "id": "await_approval",
        "op": "await_event",
        "event": "demo/ApprovalEvent@1",
        "where": {
          "op": "and",
          "args": [
            {
              "op": "eq",
              "args": [
                { "ref": "@event.request_id" },
                { "ref": "@plan.input.request_id" }
              ]
            },
            {
              "op": "eq",
              "args": [
                { "ref": "@event.approved" },
                { "bool": true }
              ]
            }
          ]
        },
        "bind": { "as": "approval_event" }
      },
      {
        "id": "finish",
        "op": "end"
      }
    ],
    "edges": [
      { "from": "await_approval", "to": "finish" }
    ],
    "required_caps": [],
    "allowed_effects": []
  },
  {
    "$kind": "defplan",
    "name": "demo/_internal_worker_fetch@1",
    "input": "demo/WorkerUrl@1",
    "output": "demo/WorkerResult@1",
    "steps": [
      {
        "id": "emit_fetch",
        "op": "emit_effect",
        "kind": "http.request",
        "params": {
          "record": {
            "method": { "text": "GET" },
            "url": { "ref": "@plan.input" },
            "headers": { "map": [] },
            "body_ref": { "null": {} }
          }
        },
        "cap": "cap_http",
        "idempotency_key": {
          "op": "hash",
          "args": [
            { "ref": "@plan.input" }
          ]
        },
        "bind": { "effect_id_as": "req" }
      },
      {
        "id": "await_fetch",
        "op": "await_receipt",
        "for": { "ref": "@var:req" },
        "bind": { "as": "receipt" }
      },
      {
        "id": "finish",
        "op": "end",
        "result": { "ref": "@plan.input" }
      }
    ],
    "edges": [
      { "from": "emit_fetch", "to": "await_fetch" },
      { "from": "await_fetch", "to": "finish" }
    ],
    "required_caps": ["cap_http"],
    "allowed_effects": ["http.request"]
  }
]
