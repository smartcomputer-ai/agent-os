[
  {
    "$kind": "defplan",
    "name": "demo/fetch_plan@1",
    "input": "demo/FetchRequest@1",
    "steps": [
      {
        "id": "emit_http",
        "op": "emit_effect",
        "kind": "http.request",
        "params": {
          "method": "GET",
          "url": "https://example.com/data.json",
          "headers": {},
          "body_ref": null
        },
        "cap": "cap_http_fetch",
        "bind": { "effect_id_as": "http_req" }
      },
      {
        "id": "await_http",
        "op": "await_receipt",
        "for": { "ref": "@var:http_req" },
        "bind": { "as": "http_receipt" }
      },
      {
        "id": "capture_status",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            { "ref": "@var:http_receipt" },
            { "text": "status" }
          ]
        },
        "bind": { "as": "receipt_status" }
      },
      {
        "id": "capture_body",
        "op": "assign",
        "expr": {
          "op": "get",
          "args": [
            { "ref": "@var:http_receipt" },
            { "text": "body_preview" }
          ]
        },
        "bind": { "as": "receipt_body" }
      },
      {
        "id": "raise_result",
        "op": "raise_event",
        "reducer": "demo/FetchNotify@1",
        "event": {
          "variant": {
            "tag": "NotifyComplete",
            "value": {
              "record": {
                "status": { "ref": "@var:receipt_status" },
                "body_preview": { "ref": "@var:receipt_body" }
              }
            }
          }
        }
      },
      {
        "id": "finish",
        "op": "end"
      }
    ],
    "edges": [
      { "from": "emit_http", "to": "await_http" },
      { "from": "await_http", "to": "capture_status" },
      { "from": "capture_status", "to": "capture_body" },
      { "from": "capture_body", "to": "raise_result" },
      { "from": "raise_result", "to": "finish" }
    ],
    "required_caps": ["cap_http_fetch"],
    "allowed_effects": ["http.request"]
  }
]
