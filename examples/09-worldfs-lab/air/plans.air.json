[
  {
    "$kind": "defplan",
    "name": "notes/SnapshotPlan@1",
    "input": "notes/SnapshotRequested@1",
    "steps": [
      {
        "id": "put_blob",
        "op": "emit_effect",
        "kind": "blob.put",
        "params": {
          "record": {
            "namespace": { "ref": "@plan.input.namespace" },
            "blob_ref": { "ref": "@plan.input.report_hash" }
          }
        },
        "cap": "cap_blob",
        "bind": { "effect_id_as": "blob_put_id" }
      },
      {
        "id": "await_blob",
        "op": "await_receipt",
        "for": { "ref": "@var:blob_put_id" },
        "bind": { "as": "blob_put_receipt" }
      },
      {
        "id": "register_obj",
        "op": "raise_event",
        "reducer": "sys/ObjectCatalog@1",
        "key": { "ref": "@plan.input.object_path" },
        "event": {
          "record": {
            "meta": {
              "record": {
                "name": { "ref": "@plan.input.object_path" },
                "kind": { "text": "note.report" },
                "hash": { "ref": "@plan.input.report_hash" },
                "tags": { "set": [ { "text": "report" }, { "text": "worldfs" } ] },
                "created_at": { "ref": "@plan.input.created_at" },
                "owner": { "text": "notes/notebook@1" }
              }
            }
          }
        }
      },
      {
        "id": "archive_note",
        "op": "raise_event",
        "reducer": "notes/NotebookSM@1",
        "key": { "ref": "@plan.input.note_id" },
        "event": {
          "variant": {
            "tag": "Archived",
            "value": {
              "record": {
                "note_id": { "ref": "@plan.input.note_id" },
                "report_hash": { "ref": "@plan.input.report_hash" }
              }
            }
          }
        }
      },
      { "id": "finish", "op": "end" }
    ],
    "edges": [
      { "from": "put_blob", "to": "await_blob" },
      { "from": "await_blob", "to": "register_obj" },
      { "from": "register_obj", "to": "archive_note" },
      { "from": "archive_note", "to": "finish" }
    ],
    "required_caps": ["cap_blob"],
    "allowed_effects": ["blob.put"]
  }
]
