{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aos.dev/air/v1/patch.schema.json",
  "title": "AIR v1 Manifest Patch",
  "type": "object",
  "properties": {
    "version": {
      "description": "Patch document format version (string major). v1 kernels only accept \"1\".",
      "type": "string",
      "enum": ["1"],
      "default": "1"
    },
    "base_manifest_hash": { "$ref": "common.schema.json#/$defs/Hash" },
    "patches": {
      "type": "array",
      "minItems": 1,
      "items": {
        "oneOf": [
          { "$ref": "#/$defs/add_def" },
          { "$ref": "#/$defs/replace_def" },
          { "$ref": "#/$defs/remove_def" },
          { "$ref": "#/$defs/set_manifest_refs" },
          { "$ref": "#/$defs/set_defaults" },
          { "$ref": "#/$defs/set_routing_events" },
          { "$ref": "#/$defs/set_routing_inboxes" },
          { "$ref": "#/$defs/set_module_bindings" },
          { "$ref": "#/$defs/set_secrets" }
        ]
      }
    }
  },
  "required": ["base_manifest_hash", "patches"],
  "additionalProperties": false,

  "$defs": {
    "node_json": {
      "description": "Authoring form of any AIR node (defschema, defmodule, defeffect, defcap, defpolicy, defsecret). Structural validation happens in the loader; patch schema only checks presence and basic typing.",
      "type": "object",
      "minProperties": 1
    },

    "add_def": {
      "type": "object",
      "properties": {
        "add_def": {
          "type": "object",
          "properties": {
            "kind": { "$ref": "common.schema.json#/$defs/DefKind" },
            "node": { "$ref": "#/$defs/node_json" }
          },
          "required": ["kind", "node"],
          "additionalProperties": false
        }
      },
      "required": ["add_def"],
      "additionalProperties": false
    },

    "replace_def": {
      "type": "object",
      "properties": {
        "replace_def": {
          "type": "object",
          "properties": {
            "kind": { "$ref": "common.schema.json#/$defs/DefKind" },
            "name": { "$ref": "common.schema.json#/$defs/Name" },
            "new_node": { "$ref": "#/$defs/node_json" },
            "pre_hash": { "$ref": "common.schema.json#/$defs/Hash" }
          },
          "required": ["kind", "name", "new_node", "pre_hash"],
          "additionalProperties": false
        }
      },
      "required": ["replace_def"],
      "additionalProperties": false
    },

    "remove_def": {
      "type": "object",
      "properties": {
        "remove_def": {
          "type": "object",
          "properties": {
            "kind": { "$ref": "common.schema.json#/$defs/DefKind" },
            "name": { "$ref": "common.schema.json#/$defs/Name" },
            "pre_hash": { "$ref": "common.schema.json#/$defs/Hash" }
          },
          "required": ["kind", "name", "pre_hash"],
          "additionalProperties": false
        }
      },
      "required": ["remove_def"],
      "additionalProperties": false
    },

    "set_manifest_refs": {
      "type": "object",
      "properties": {
        "set_manifest_refs": {
          "type": "object",
          "properties": {
            "add": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "kind": { "$ref": "common.schema.json#/$defs/DefKind" },
                  "name": { "$ref": "common.schema.json#/$defs/Name" },
                  "hash": { "$ref": "common.schema.json#/$defs/Hash" }
                },
                "required": ["kind", "name", "hash"],
                "additionalProperties": false
              }
            },
            "remove": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "kind": { "$ref": "common.schema.json#/$defs/DefKind" },
                  "name": { "$ref": "common.schema.json#/$defs/Name" }
                },
                "required": ["kind", "name"],
                "additionalProperties": false
              }
            }
          },
          "anyOf": [
            { "required": ["add"] },
            { "required": ["remove"] }
          ],
          "additionalProperties": false
        }
      },
      "required": ["set_manifest_refs"],
      "additionalProperties": false
    },

    "set_defaults": {
      "type": "object",
      "properties": {
        "set_defaults": {
          "type": "object",
          "properties": {
            "policy": {
              "oneOf": [
                { "$ref": "common.schema.json#/$defs/Name" },
                { "type": "null" }
              ]
            },
            "cap_grants": {
              "type": "array",
              "items": { "$ref": "common.schema.json#/$defs/CapGrant" }
            }
          },
          "additionalProperties": false
        }
      },
      "required": ["set_defaults"],
      "additionalProperties": false
    }
    ,

    "set_routing_events": {
      "type": "object",
      "properties": {
        "set_routing_events": {
          "type": "object",
          "properties": {
            "pre_hash": { "$ref": "common.schema.json#/$defs/Hash" },
            "subscriptions": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "event": { "$ref": "common.schema.json#/$defs/SchemaRef" },
                  "module": { "$ref": "common.schema.json#/$defs/Name" },
                  "key_field": { "type": "string" }
                },
                "required": ["event","module"],
                "additionalProperties": false
              }
            }
          },
          "required": ["pre_hash","subscriptions"],
          "additionalProperties": false
        }
      },
      "required": ["set_routing_events"],
      "additionalProperties": false
    },

    "set_routing_inboxes": {
      "type": "object",
      "properties": {
        "set_routing_inboxes": {
          "type": "object",
          "properties": {
            "pre_hash": { "$ref": "common.schema.json#/$defs/Hash" },
            "inboxes": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "source": { "type": "string" },
                  "workflow": { "$ref": "common.schema.json#/$defs/Name" }
                },
                "required": ["source","workflow"],
                "additionalProperties": false
              }
            }
          },
          "required": ["pre_hash","inboxes"],
          "additionalProperties": false
        }
      },
      "required": ["set_routing_inboxes"],
      "additionalProperties": false
    },

    "set_module_bindings": {
      "type": "object",
      "properties": {
        "set_module_bindings": {
          "type": "object",
          "properties": {
            "pre_hash": { "$ref": "common.schema.json#/$defs/Hash" },
            "bindings": {
              "type": "object",
              "patternProperties": {
                "^[a-z][a-z0-9._-]*/[A-Za-z][A-Za-z0-9._-]*@[1-9][0-9]*$": {
                  "type": "object",
                  "properties": {
                    "slots": {
                      "type": "object",
                      "patternProperties": {
                        "^[A-Za-z_][A-Za-z0-9_.-]{0,63}$": { "$ref": "common.schema.json#/$defs/CapGrantName" }
                      },
                      "additionalProperties": false
                    }
                  },
                  "required": ["slots"],
                  "additionalProperties": false
                }
              },
              "additionalProperties": false
            }
          },
          "required": ["pre_hash","bindings"],
          "additionalProperties": false
        }
      },
      "required": ["set_module_bindings"],
      "additionalProperties": false
    },

    "set_secrets": {
      "type": "object",
      "properties": {
        "set_secrets": {
          "type": "object",
          "properties": {
            "pre_hash": { "$ref": "common.schema.json#/$defs/Hash" },
            "secrets": {
              "type": "array",
              "items": {
                "oneOf": [
                  {
                    "type": "object",
                    "properties": {
                      "name": { "$ref": "common.schema.json#/$defs/Name" },
                      "hash": { "$ref": "common.schema.json#/$defs/Hash" }
                    },
                    "required": ["name","hash"],
                    "additionalProperties": false
                  },
                  {
                    "type": "object",
                    "properties": {
                      "alias": { "type": "string" },
                      "version": { "type": "integer", "minimum": 0 },
                      "binding_id": { "type": "string" },
                      "expected_digest": { "$ref": "common.schema.json#/$defs/Hash" },
                      "policy": {
                        "type": "object",
                        "properties": {
                          "allowed_caps": {
                            "type": "array",
                            "items": { "$ref": "common.schema.json#/$defs/CapGrantName" }
                          }
                        },
                        "additionalProperties": false
                      }
                    },
                    "required": ["alias","version","binding_id"],
                    "additionalProperties": false
                  }
                ]
              }
            }
          },
          "required": ["pre_hash","secrets"],
          "additionalProperties": false
        }
      },
      "required": ["set_secrets"],
      "additionalProperties": false
    }
  }
}
