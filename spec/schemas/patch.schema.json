{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aos.dev/air/v1/patch.schema.json",
  "title": "AIR v1 Manifest Patch",
  "type": "object",
  "properties": {
    "base_manifest_hash": { "$ref": "common.schema.json#/$defs/Hash" },
    "patches": {
      "type": "array",
      "minItems": 1,
      "items": {
        "oneOf": [
          { "$ref": "#/$defs/add_def" },
          { "$ref": "#/$defs/replace_def" },
          { "$ref": "#/$defs/remove_def" },
          { "$ref": "#/$defs/set_manifest_refs" },
          { "$ref": "#/$defs/set_defaults" }
        ]
      }
    }
  },
  "required": ["base_manifest_hash", "patches"],
  "additionalProperties": false,

  "$defs": {
    "node_json": {
      "description": "Authoring form of any AIR node (defschema, defmodule, defplan, defeffect, defcap, defpolicy, defsecret). Structural validation happens in the loader; patch schema only checks presence and basic typing.",
      "type": "object",
      "minProperties": 1
    },

    "add_def": {
      "type": "object",
      "properties": {
        "add_def": {
          "type": "object",
          "properties": {
            "kind": { "type": "string" },
            "node": { "$ref": "#/$defs/node_json" }
          },
          "required": ["kind", "node"],
          "additionalProperties": false
        }
      },
      "required": ["add_def"],
      "additionalProperties": false
    },

    "replace_def": {
      "type": "object",
      "properties": {
        "replace_def": {
          "type": "object",
          "properties": {
            "kind": { "type": "string" },
            "name": { "$ref": "common.schema.json#/$defs/Name" },
            "new_node": { "$ref": "#/$defs/node_json" },
            "pre_hash": { "$ref": "common.schema.json#/$defs/Hash" }
          },
          "required": ["kind", "name", "new_node", "pre_hash"],
          "additionalProperties": false
        }
      },
      "required": ["replace_def"],
      "additionalProperties": false
    },

    "remove_def": {
      "type": "object",
      "properties": {
        "remove_def": {
          "type": "object",
          "properties": {
            "kind": { "type": "string" },
            "name": { "$ref": "common.schema.json#/$defs/Name" },
            "pre_hash": { "$ref": "common.schema.json#/$defs/Hash" }
          },
          "required": ["kind", "name", "pre_hash"],
          "additionalProperties": false
        }
      },
      "required": ["remove_def"],
      "additionalProperties": false
    },

    "set_manifest_refs": {
      "type": "object",
      "properties": {
        "set_manifest_refs": {
          "type": "object",
          "properties": {
            "add": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "kind": { "type": "string" },
                  "name": { "$ref": "common.schema.json#/$defs/Name" },
                  "hash": { "$ref": "common.schema.json#/$defs/Hash" }
                },
                "required": ["kind", "name", "hash"],
                "additionalProperties": false
              }
            },
            "remove": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "kind": { "type": "string" },
                  "name": { "$ref": "common.schema.json#/$defs/Name" }
                },
                "required": ["kind", "name"],
                "additionalProperties": false
              }
            }
          },
          "required": ["add"],
          "additionalProperties": false
        }
      },
      "required": ["set_manifest_refs"],
      "additionalProperties": false
    },

    "set_defaults": {
      "type": "object",
      "properties": {
        "set_defaults": {
          "type": "object",
          "properties": {
            "policy": {
              "oneOf": [
                { "$ref": "common.schema.json#/$defs/Name" },
                { "type": "null" }
              ]
            },
            "cap_grants": {
              "type": "array",
              "items": { "$ref": "common.schema.json#/$defs/CapGrant" }
            }
          },
          "additionalProperties": false
        }
      },
      "required": ["set_defaults"],
      "additionalProperties": false
    }
  }
}
