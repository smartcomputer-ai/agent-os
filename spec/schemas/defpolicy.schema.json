{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aos.dev/air/v1/defpolicy.schema.json",
  "title": "AIR v1 defpolicy",
  "description": "Policy rule pack for allow/deny decisions at effect enqueue time. v1: origin-aware matching, no approvals or rate limits.",
  "type": "object",
  "properties": {
    "$kind": { "const": "defpolicy" },
    "name": { "$ref": "common.schema.json#/$defs/Name" },
    "rules": {
      "type": "array",
      "items": { "$ref": "#/$defs/Rule" }
    }
  },
  "required": ["$kind","name","rules"],
  "additionalProperties": false,
  "$defs": {
    "Rule": {
      "type": "object",
      "properties": {
        "when": { "$ref": "#/$defs/Match" },
        "decision": {
          "type": "string",
          "enum": ["allow","deny"],
          "description": "v1: allow or deny only. require_approval reserved for v1.1+"
        }
      },
      "required": ["when","decision"],
      "additionalProperties": false
    },
    "Match": {
      "type": "object",
      "description": "Match conditions for policy rules. All fields optional; first rule matching all provided conditions wins.",
      "properties": {
        "effect_kind": {
          "$ref": "common.schema.json#/$defs/EffectKind",
          "description": "Match effect kind (namespaced string; built-in catalog documented in spec/03-air.md, custom kinds allowed when registered by adapters)"
        },
        "cap_name": {
          "$ref": "common.schema.json#/$defs/CapGrantName",
          "description": "Match capability grant name"
        },
        "cap_type": {
          "$ref": "common.schema.json#/$defs/CapType",
          "description": "Match capability type (from the resolved grant)"
        },
        "origin_kind": {
          "type": "string",
          "enum": ["plan", "reducer"],
          "description": "Match whether effect originates from a plan or reducer"
        },
        "origin_name": {
          "$ref": "common.schema.json#/$defs/Name",
          "description": "Match specific plan or reducer name"
        }
      },
      "additionalProperties": false
    }
  }
}
